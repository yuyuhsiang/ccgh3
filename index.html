<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>人員統計上傳與分析</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    /* 基本樣式 */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    /* 頁面佈局 */
    body {
      display: flex;
      height: 100vh;
      font-family: Arial, sans-serif;
      background-color: #f0f2f5;
      padding: 1rem;
      gap: 1rem;
    }

    /* 左側控制區樣式 */
    #controls {
      width: 45%;
      padding: 1rem;
      background-color: #ffffff;
      overflow-y: auto;
      border: 1px solid #ccc;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
    }
    #controls h2 { font-size: 1.2rem; margin-bottom: 0.5rem; border-bottom: 1px solid #ddd; padding-bottom: 0.3rem; }
    #controls label, #controls input, #controls select { display: block; width: 100%; margin-bottom: 0.8rem; font-size: 0.95rem; }
    #controls input[type="file"] { padding: 0.3rem; }
    
    /* 表格樣式 */
    .table-container {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    thead { background-color: #eaeaea; flex-shrink: 0; }
    th, td { border: 1px solid #ddd; padding: 0.4rem; text-align: center; }
    tbody { display: block; overflow-y: auto; }
    thead, tbody tr { display: table; width: 100%; table-layout: fixed; }
    tbody tr:nth-child(even) { background-color: #f9f9f9; }

    /* 右側圖表區樣式 */
    #charts-container {
      width: 55%;
      display: flex;
      flex-direction: column;
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: #ffffff;
      overflow: hidden;
    }
    
    .tab-bar { border-bottom: 1px solid #ccc; display: flex; flex-shrink: 0; }
    .tab-button {
      background-color: #f1f1f1; border: none; border-right: 1px solid #ccc;
      padding: 10px 15px; cursor: pointer; font-size: 1rem;
    }
    .tab-button:last-child { border-right: none; }
    .tab-button:hover { background-color: #ddd; }
    .tab-button.active { background-color: #fff; font-weight: bold; }

    .chart-content {
      flex-grow: 1; padding: 1rem; opacity: 0; visibility: hidden;
      transition: opacity 0.3s ease-in-out; display: none;
    }
    .chart-content.active { opacity: 1; visibility: visible; display: block; }
    canvas { background-color: #fff; max-width: 100%; max-height: 100%; }

  </style>
</head>
<body>
  <aside id="controls">
    <div>
      <h2>上傳 Excel</h2>
      <input type="file" id="fileInput" accept=".xlsx,.xls">
      <h2>篩選條件</h2>
      <label>部門：
        <select id="deptSelect"><option value="">全部</option></select>
      </label>
      <label>職稱：
        <select id="titleSelect"><option value="">全部</option></select>
      </label>
      <h2>人員列表</h2>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>員編</th><th>部門</th><th>職稱</th><th>姓名</th>
            <th>年齡</th><th>到職日</th><th>年資</th><th>學歷</th><th>進階證明</th>
          </tr>
        </thead>
        <tbody id="personTable"></tbody>
      </table>
    </div>
  </aside>

  <main id="charts-container">
    <div class="tab-bar">
      <button class="tab-button active" onclick="openChart(event, 'age')">年齡分布</button>
      <button class="tab-button" onclick="openChart(event, 'edu')">學歷分布</button>
      <button class="tab-button" onclick="openChart(event, 'cert')">進階證明</button>
    </div>
    <div id="age" class="chart-content active">
      <canvas id="ageChart"></canvas>
    </div>
    <div id="edu" class="chart-content">
      <canvas id="eduChart"></canvas>
    </div>
    <div id="cert" class="chart-content">
      <canvas id="certChart"></canvas>
    </div>
  </main>

  <script>
    Chart.register(ChartDataLabels);

    let rawData = [], filtered = [];
    const fileInput = document.getElementById('fileInput');
    const deptSel = document.getElementById('deptSelect');
    const titleSel = document.getElementById('titleSelect');
    const tableBody = document.getElementById('personTable');
    let ageChart, eduChart, certChart;
    let chartsInitialized = false;

    function openChart(evt, chartName) {
      const chartContents = document.getElementsByClassName("chart-content");
      for (let i = 0; i < chartContents.length; i++) {
        chartContents[i].classList.remove("active");
      }
      const tabButtons = document.getElementsByClassName("tab-button");
      for (let i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove("active");
      }
      document.getElementById(chartName).classList.add("active");
      evt.currentTarget.classList.add("active");
    }

    fileInput.addEventListener('change', e => {
      const f = e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = evt => {
        const data = new Uint8Array(evt.target.result);
        const wb = XLSX.read(data, { type:'array', cellDates:true });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws, { defval: '' });
        rawData = json.map(item => {
          const ageKey = '年齡(出生日期，自動換算';
          const ageValue = item[ageKey] !== undefined ? parseInt(item[ageKey]) : 0;
          let doj = item['到職日'];
          if (doj instanceof Date) doj = doj.toISOString().split('T')[0];
          return {
            員編: item['員編'] || '', 部門: item['部門'] || '未填', 職稱: item['職稱'] || '未填',
            姓名: item['姓名'] || '', 年齡: ageValue, 到職日: doj || '',
            年資: item['年資(到職日，自動換算)'] || '', 學歷: item['學歷'] || '未填', 證明: item['護理人員進階證明'] || '未填'
          };
        });
        if (!chartsInitialized) {
          initializeCharts();
        }
        initFilters();
        applyFilter();
      };
      reader.readAsArrayBuffer(f);
    });
    
    function initializeCharts() {
      const paleColors = ['#A8D5E2','#FFE5A5','#D5E8D4','#F8CCD1','#E6D5F5','#F5E6D5'];
      
      ageChart = new Chart(document.getElementById('ageChart'), {
        type: 'bar', data: { labels: [], datasets: [{ label: '人數', data: [], backgroundColor: paleColors[0] }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: '年齡分布' }, datalabels: { color: '#333', anchor: 'end', align: 'top' } }, scales: { y: { beginAtZero: true } } }
      });

      eduChart = new Chart(document.getElementById('eduChart'), {
        type: 'pie', data: { labels: [], datasets: [{ data: [], backgroundColor: paleColors.slice(1) }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: '學歷分布' }, datalabels: { formatter: (v, ctx) => ctx.chart.data.labels[ctx.dataIndex] + ':' + v + '人', color: '#333' } } }
      });

      certChart = new Chart(document.getElementById('certChart'), {
        type: 'pie', data: { labels: [], datasets: [{ data: [], backgroundColor: paleColors.slice(2) }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: '進階證明' }, datalabels: { formatter: (v, ctx) => ctx.chart.data.labels[ctx.dataIndex] + ':' + v + '人', color: '#333' } } }
      });
      chartsInitialized = true;
    }

    function initFilters() {
      deptSel.innerHTML = '<option value="">全部</option>';
      titleSel.innerHTML = '<option value="">全部</option>';
      const depts = [...new Set(rawData.map(d => d.部門))].sort();
      const titles = [...new Set(rawData.map(d => d.職稱))].sort();
      depts.forEach(d => deptSel.append(new Option(d, d)));
      titles.forEach(t => titleSel.append(new Option(t, t)));
      deptSel.onchange = titleSel.onchange = applyFilter;
    }

    function applyFilter() {
      const d = deptSel.value, t = titleSel.value;
      filtered = rawData.filter(item => (d === '' || item.部門 === d) && (t === '' || item.職稱 === t));
      renderTable();
      if (chartsInitialized) {
        renderCharts();
      }
    }

    function renderTable() {
      tableBody.innerHTML = '';
      filtered.forEach(p => {
        const tr = document.createElement('tr');
        ['員編','部門','職稱','姓名','年齡','到職日','年資','學歷','證明'].forEach(key => {
          const td = document.createElement('td');
          td.textContent = p[key];
          tr.append(td);
        });
        tableBody.append(tr);
      });
    }

    function countBy(arr, key) {
      return arr.reduce((acc, cur) => {
        const k = cur[key] || '未填';
        acc[k] = (acc[k] || 0) + 1;
        return acc;
      }, {});
    }
    
    function renderCharts() {
      // --- 唯一的修改處 ---
      const bins = ['18-25','26-30','31-35','36-40','41-45','46-50','51-55','56-60','61-65','66-70'];
      
      const ageCounts = bins.map(bin => {
        const [min, max] = bin.split('-').map(Number);
        return filtered.filter(p => p.年齡 >= min && p.年齡 <= max).length;
      });
      const edus = countBy(filtered, '學歷');
      const certs = countBy(filtered, '證明');

      ageChart.data.labels = bins;
      ageChart.data.datasets[0].data = ageCounts;
      ageChart.update();

      eduChart.data.labels = Object.keys(edus);
      eduChart.data.datasets[0].data = Object.values(edus);
      eduChart.update();

      certChart.data.labels = Object.keys(certs);
      certChart.data.datasets[0].data = Object.values(certs);
      certChart.update();
    }
  </script>
</body>
</html>